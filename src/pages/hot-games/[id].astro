---
import Layout from '../../layouts/Layout.astro';
import gamesData from '../../data/games.json';

// 内容组件（按你原来）
import BlockBlastContent from '../../components/games/BlockBlastContent.astro';
import ColorJamContent from '../../components/games/ColorJamContent.astro';
import SandBlastContent from '../../components/games/SandBlastContent.astro';
import StickholeContent from '../../components/games/StickholeContent.astro';

export async function getStaticPaths() {
  // 仅导出 type 为 iframe 且有 id 的数据
  const validGames = gamesData.filter((g) => g.type === 'iframe' && g.id);
  
  return validGames.map((game) => ({
    params: { id: String(game.id) }, // 强制转为字符串防止 404
    props: { game },
  }));
}

// 1. 获取 ID 和 Props
const { id } = Astro.params;
const { game: propsGame } = Astro.props;

// 2. 容错逻辑：如果 props 丢失，从 JSON 找回
const game = propsGame || gamesData.find(g => String(g.id) === id);

// 3. 彻底找不到的极端情况处理
if (!game) {
  return Astro.redirect('/404');
}

// 组件映射
const GameComponents: Record<string, any> = {
  'block-blast': BlockBlastContent,
  'color-block-jam': ColorJamContent,
  'sand-blast-block': SandBlastContent,
  'stickhole-io': StickholeContent,
};

const SpecificGameContent = GameComponents[game.id] || null;

// 相关游戏逻辑
const relatedGames = gamesData
  .filter((g) => g.type === 'iframe' && g.id !== game.id)
  .slice(0, 6);

// SEO 
const title = `Play ${game.title} Online Free | KnitOut.net`;
const description = game.description || `Play ${game.title} online for free. No download required. Fullscreen supported.`;
const canonical = `https://www.knitout.net/hot-games/${game.id}`;

// JSON-LD (VideoGame)
const gameSchema = {
  "@context": "https://schema.org",
  "@type": "VideoGame",
  "name": game.title,
  "description": description,
  "url": canonical,
  "applicationCategory": "Game",
  "operatingSystem": "Web",
  "inLanguage": "en",
  "publisher": { "@type": "Organization", "name": "KnitOut.net" }
};

// ✅ 复用你 index 页的颜色映射（同款）
const getGameColors = (id: string) => {
  const colorMap: Record<string, { gradient: string; light: string; text: string }> = {
    'knit-out': { gradient: 'linear-gradient(135deg, #3b82f6, #2563eb)', light: 'rgba(59, 130, 246, 0.1)', text: '#3b82f6'},
    'cookingdom': { gradient: 'linear-gradient(135deg, #10b981, #059669)', light: 'rgba(16, 185, 129, 0.1)', text: '#10b981'},
    'block-blast': { gradient: 'linear-gradient(135deg, #8b5cf6, #7c3aed)', light: 'rgba(139, 92, 246, 0.1)', text: '#8b5cf6'},
    'sand-blast-block': { gradient: 'linear-gradient(135deg, #f59e0b, #d97706)', light: 'rgba(245, 158, 11, 0.1)', text: '#f59e0b'},
    'stickhole-io': { gradient: 'linear-gradient(135deg, #ec4899, #db2777)', light: 'rgba(236, 72, 153, 0.1)', text: '#ec4899'},
    'color-block-jam': { gradient: 'linear-gradient(135deg, #06b6d4, #0891b2)', light: 'rgba(6, 182, 212, 0.1)', text: '#06b6d4'}
  };
  return colorMap[id] || { gradient: 'linear-gradient(135deg, #6b7280, #4b5563)', light: 'rgba(107, 114, 128, 0.1)', text: '#6b7280'};
};

const colors = getGameColors(game.id);
---

<Layout title={title} description={description} canonical={canonical}>
  <script type="application/ld+json" set:html={JSON.stringify(gameSchema)} slot="head" />

  <div class="game-detail-page"
    style={`--game-gradient:${colors.gradient};--game-light:${colors.light};--game-text:${colors.text};`}>
    <div class="container">

      <!-- 顶部导航（同白底体系） -->
      <div class="topbar">
        <a class="back-link" href="/hot-games">← Back to Hot Games</a>
        <div class="topbar-right">
          <span class="pill">Free • Browser Game</span>
        </div>
      </div>

      <!-- 标题区 -->
      <header class="hero">
        <div class="hero-left">
          <div class="icon">
            <span class="icon-inner" aria-hidden="true">
              <!-- 你用 fontawesome 就保留 i -->
              <i class={`fas ${game.thumbnail}`}></i>
            </span>
          </div>
          <div class="hero-text">
            <h1 class="h1">{game.title}</h1>
            <p class="sub">{game.description}</p>
          </div>
        </div>

        <div class="hero-actions">
          <button id="fullscreen-btn" class="btn btn-primary" type="button">
            Fullscreen
          </button>
        </div>
      </header>

      <!-- 游戏 iframe（居中，同宽） -->
      <section class="card game-card">
        <div id="game-wrapper" class="game-frame">
          <div id="loading" class="loading">
            Loading game…
          </div>

          <iframe
            id="game-iframe"
            src={game.iframeUrl}
            title={game.title}
            allowfullscreen
            loading="lazy"
            frameborder="0"
          ></iframe>
        </div>

        <div class="game-meta">
          <div class="meta-left">
            <span class="dot"></span>
            <span>Instant play • No download</span>
          </div>
          <a class="meta-link" href="#guide">Jump to guide ↓</a>
        </div>
      </section>

      <!-- 攻略 / 内容（同宽居中） -->
      <section id="guide" class="card content-card">
        {SpecificGameContent ? (
          <article class="prose">
            <SpecificGameContent />
          </article>
        ) : (
          <article class="prose">
            <h2>About {game.title}</h2>
            <p>{game.description}</p>
            <h3>Tips</h3>
            <ul>
              <li>Play in fullscreen for the best experience.</li>
              <li>Refresh the page if the game fails to load.</li>
              <li>Use Chrome for the smoothest performance.</li>
            </ul>
          </article>
        )}
      </section>

      <!-- More Games（复用首页卡片风格） -->
      <section class="section">
        <div class="section-header">
          <h2 class="section-title">More Games</h2>
          <p class="section-subtitle">Try another popular pick from the arcade.</p>
        </div>

        <div class="grid">
          {relatedGames.map((g) => {
            const c = getGameColors(g.id);
            const url = `/hot-games/${g.id}`;
            return (
              <a
                href={url}
                class="mini-card"
                style={`--game-gradient:${c.gradient};--game-light:${c.light};--game-text:${c.text};`}
              >
                <div class="mini-top"></div>
                <div class="mini-body">
                  <div class="mini-title">{g.title}</div>
                  <div class="mini-desc">{g.description}</div>
                  <div class="mini-cta">Play Now →</div>
                </div>
              </a>
            );
          })}
        </div>
      </section>

    </div>
  </div>

  <script>
    const btn = document.getElementById('fullscreen-btn') as HTMLButtonElement | null;
    const wrapper = document.getElementById('game-wrapper') as HTMLElement | null;
    const iframe = document.getElementById('game-iframe') as HTMLIFrameElement | null;
    const loading = document.getElementById('loading') as HTMLElement | null;

    iframe?.addEventListener('load', () => {
      if (loading) loading.style.display = 'none';
    });

    function requestFullscreen(el: HTMLElement | null) {
      if (!el) return;
      const anyEl = el as any;
      if (anyEl.requestFullscreen) return anyEl.requestFullscreen();
      if (anyEl.webkitRequestFullscreen) return anyEl.webkitRequestFullscreen();
      if (anyEl.msRequestFullscreen) return anyEl.msRequestFullscreen();
    }

    btn?.addEventListener('click', () => {
      // 推荐：让容器全屏（体验比 iframe 本体更稳定）
      requestFullscreen(wrapper);
    });
  </script>
</Layout>

<style>
  /* ====== 复用 index.astro 的变量体系（白底卡片风格） ====== */
  :root{
    --bg-page:#f9fafb;
    --bg-card:#ffffff;
    --text-dark:#1f2937;
    --text-gray:#6b7280;
    --text-light:#9ca3af;
    --border-color:#e5e7eb;
    --border-light:#f3f4f6;

    --radius-sm:8px;
    --radius-md:12px;
    --radius-lg:16px;
    --radius-xl:20px;

    --shadow-sm:0 1px 3px rgba(0,0,0,.08);
    --shadow-md:0 4px 10px rgba(0,0,0,.08);
    --shadow-lg:0 18px 30px rgba(0,0,0,.12);

    --transition: all .25s cubic-bezier(.4,0,.2,1);
  }

  /* 页面容器：中间主列（同你 index） */
  .game-detail-page{
    background: var(--bg-page);
    min-height: 100vh;
    padding: 2.5rem 0 5rem;
    overflow-x: clip;
    color: var(--text-dark);
  }

  .container{
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 1.25rem;
  }

  /* 顶部条 */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom: 1.75rem;
  }
  .back-link{
    color: var(--text-gray);
    text-decoration:none;
    font-weight: 700;
  }
  .back-link:hover{ color: var(--text-dark); }
  .pill{
    font-size: .75rem;
    font-weight: 800;
    letter-spacing: .04em;
    text-transform: uppercase;
    color: var(--text-gray);
    background: var(--border-light);
    border: 1px solid var(--border-color);
    padding: .4rem .75rem;
    border-radius: 999px;
  }

  /* Hero */
  .hero{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .hero-left{
    display:flex;
    gap: 1rem;
    min-width: 0;
  }
  .icon{
    width: 56px;
    height: 56px;
    border-radius: var(--radius-lg);
    background: var(--game-light);
    border: 1px solid rgba(0,0,0,.06);
    box-shadow: var(--shadow-sm);
    display:flex;
    align-items:center;
    justify-content:center;
    flex: 0 0 auto;
  }
  .icon-inner{
    width: 40px;
    height: 40px;
    border-radius: 14px;
    background: var(--bg-card);
    display:flex;
    align-items:center;
    justify-content:center;
    color: var(--game-text);
    border: 1px solid rgba(0,0,0,.06);
  }
  .h1{
    font-size: 2rem;
    line-height: 1.1;
    font-weight: 900;
    margin: 0 0 .4rem;
  }
  .sub{
    margin: 0;
    color: var(--text-gray);
    line-height: 1.6;
    max-width: 70ch;
  }

  .hero-actions{
    flex: 0 0 auto;
    display:flex;
    gap: .75rem;
    align-items:center;
  }

  /* Buttons */
  .btn{
    appearance:none;
    border: 1px solid var(--border-color);
    border-radius: 999px;
    padding: .7rem 1.05rem;
    font-weight: 800;
    cursor:pointer;
    transition: var(--transition);
    background: var(--bg-card);
    color: var(--text-dark);
  }
  .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-md); }

  .btn-primary{
    border: none;
    color: #fff;
    background: var(--game-gradient);
  }

  /* Card */
  .card{
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    overflow: hidden;
  }

  /* Game frame */
  .game-card{ margin-bottom: 1.75rem; }
  .game-frame{
    position: relative;
    width: 100%;
    aspect-ratio: 16/9;
    background: #000;
  }
  .game-frame iframe{
    width:100%;
    height:100%;
    border:0;
    display:block;
  }
  .loading{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    color: rgba(255,255,255,.9);
    background: rgba(0,0,0,.55);
    font-weight: 800;
    letter-spacing: .02em;
  }

  .game-meta{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 1rem;
    padding: .85rem 1.1rem;
    border-top: 1px solid var(--border-light);
    color: var(--text-gray);
    font-weight: 700;
    font-size: .9rem;
  }
  .meta-left{ display:flex; align-items:center; gap:.6rem; }
  .dot{
    width:10px; height:10px;
    border-radius: 50%;
    background: #10b981;
    box-shadow: 0 0 0 4px rgba(16,185,129,.15);
  }
  .meta-link{
    color: var(--game-text);
    text-decoration:none;
    font-weight: 900;
  }
  .meta-link:hover{ text-decoration: underline; }

  /* Content */
  .content-card{ padding: 1.6rem; }

  /* 简易 prose（不依赖 tailwind typography） */
  .prose{
    color: var(--text-dark);
    line-height: 1.85;
  }
  .prose h2{
    margin: 0 0 .75rem;
    font-size: 1.5rem;
    font-weight: 900;
  }
  .prose h3{
    margin: 1.35rem 0 .5rem;
    font-size: 1.1rem;
    font-weight: 900;
  }
  .prose p{ color: var(--text-gray); }
  .prose ul{
    margin: .75rem 0 0;
    padding: 0;
    list-style: none;
  }
  .prose li{
    position: relative;
    padding-left: 1.25rem;
    margin: .5rem 0;
    color: var(--text-gray);
  }
  .prose li::before{
    content: "•";
    position:absolute;
    left: 0;
    color: var(--text-light);
    font-weight: 900;
  }
  .prose a{ color: var(--game-text); font-weight: 800; text-decoration: none; }
  .prose a:hover{ text-decoration: underline; }

  /* More Games */
  .section{ margin-top: 2.25rem; }
  .section-header{
    text-align:center;
    margin-bottom: 1.5rem;
  }
  .section-title{
    font-size: 1.9rem;
    font-weight: 900;
    margin: 0 0 .5rem;
  }
  .section-subtitle{
    margin: 0;
    color: var(--text-gray);
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  @media (min-width: 768px){
    .grid{ grid-template-columns: repeat(2, 1fr); }
  }
  @media (min-width: 1024px){
    .grid{ grid-template-columns: repeat(3, 1fr); }
  }

  .mini-card{
    text-decoration:none;
    display:block;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    overflow:hidden;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
  }
  .mini-card:hover{
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
  }
  .mini-top{ height: 6px; background: var(--game-gradient); }
  .mini-body{ padding: 1.1rem; }
  .mini-title{
    font-weight: 900;
    color: var(--text-dark);
    margin-bottom: .35rem;
  }
  .mini-desc{
    color: var(--text-gray);
    line-height: 1.55;
    font-size: .95rem;
    margin-bottom: .85rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .mini-cta{
    font-weight: 900;
    color: var(--game-text);
  }

  /* Responsive hero */
  @media (max-width: 768px){
    .hero{
      flex-direction: column;
      align-items: flex-start;
    }
    .hero-actions{ width: 100%; }
    .btn{ width: 100%; text-align:center; }
  }
</style>
